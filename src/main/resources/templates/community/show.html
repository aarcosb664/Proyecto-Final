<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" th:href="@{/img/logo.png}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Global stylesheet -->
    <link th:href="@{/css/community.css}" rel="stylesheet">
    <title th:text="${listing.title}">Listing</title>

    <style>
        /* Quick tweaks â€“ migrate to SCSS later */
        #gallery .carousel-item img{
            object-fit: cover;
            height: 450px;
        }
        @media (max-width: 992px){
            #gallery .carousel-item img{
                height: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="container py-4">

        <header th:insert="~{fragments/header :: header}"></header>
        
        <!-- Back -->
        <a th:href="@{/community}" class="text-decoration-none text-primary d-inline-flex align-items-center mb-3">
            <i class="bi bi-arrow-left-short fs-4"></i>Back
        </a>

        <!-- === Header (gallery + seller card) === -->
        <div class="row g-4">

            <!-- Gallery -->
            <div class="col-lg-8">
                <div id="gallery" class="carousel slide rounded shadow-sm" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div th:each="img,iterStat : ${listing.images}"
                             class="carousel-item" th:classappend="${iterStat.index == 0} ? ' active'">
                            <img th:src="${img}" class="d-block w-100 img-fluid rounded" alt="Listing image">
                        </div>
                    </div>

                    <!-- Controls -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#gallery" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#gallery" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

                <!-- Thumbnails -->
                <div class="d-flex flex-wrap gap-2 mt-2">
                    <img th:each="img,iterStat : ${listing.images}"
                         th:src="${img}"
                         data-bs-target="#gallery"
                         th:attr="data-bs-slide-to=${iterStat.index}"
                         style="width:90px;height:60px;cursor:pointer" class="img-thumbnail bg-dark border-0 rounded">
                </div>
            </div>

            <!-- Seller card -->
            <div class="col-lg-4">
                <div class="card bg-dark border-neon-blue-sm h-100 p-4 d-flex flex-column align-items-center text-center">
                    <img th:src="@{/img/default.png}" class="rounded-circle mb-3" style="width:80px;height:80px;" alt="User avatar">
                    <h5 class="mb-1" th:text="${listing.userName}">Username</h5>
                    <div class="mb-2">
                        <span class="text-warning">
                            <i class="bi bi-star-fill"></i>
                            <span th:text="${listing.rating != null ? #numbers.formatDecimal(listing.rating,1,1) : '5.0'}">5.0</span>
                        </span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted d-block"><i class="bi bi-calendar-plus"></i> <span th:text="${@prettyTime.format(listing.createdAt)}"></span></small>
                        <small class="text-muted d-block"><i class="bi bi-clock-history"></i> <span th:text="${@prettyTime.format(listing.updatedAt)}"></span></small>
                    </div>
                    <a th:href="${listing.officialUrl}" class="btn btn-neon-blue w-100 mt-2">
                        <i class="bi bi-box-arrow-up-right"></i> Official Page
                    </a>
                </div>
            </div>
        </div>

        <!-- === Description & tags === -->
        <div class="row mt-4">
            <div class="col-lg-8">
                <h4>Description</h4>
                <p th:text="${listing.description}"></p>
                <div th:if="${listing.tags != null}">
                    <span class="badge bg-secondary me-1 mb-1" th:each="tag : ${listing.tags}" th:text="${tag}"></span>
                </div>
            </div>
        </div>

        <!-- === Comment section fragment === -->
        <!-- Comment form -->
        <div id="comment-form" class="border-neon-blue p-4 mb-4">
            <h4 class="mb-3">Add a Comment</h4>
            <form th:action="@{/community/listing/{id}/comment/post(id=${listing.id})}" 
                  method="POST" 
                  th:object="${commentForm}"
                  class="needs-validation"
                  novalidate>

                <div class="mb-3">
                    <label for="title" class="form-label text-neon-white">Title</label>
                    <input type="text" class="form-control form-custom text-neon-white" 
                           id="title" th:field="*{title}" required
                           th:errorclass="is-invalid">
                    <div class="invalid-feedback text-neon-red" th:errors="*{title}"></div>
                </div>
                <div class="mb-3">
                    <label for="text" class="form-label text-neon-white">Comment</label>
                    <textarea class="form-control form-custom text-neon-white" 
                              id="text" th:field="*{text}" rows="3" required
                              th:errorclass="is-invalid"></textarea>
                    <div class="invalid-feedback text-neon-red" th:errors="*{text}"></div>
                </div>
                
                <button type="submit" class="btn-neon-green">Post Comment</button>
            </form>
        </div>

        <!-- Comments list -->
        <div id="comments" th:if="${comments != null}" th:each="comment : ${comments}" class="border-neon-blue p-4 mb-3">
            <h5 class="mb-2" th:text="${comment.userName}"></h5>
            <h6 class="text-muted mb-2" th:text="${comment.title}"></h6>
            <p class="mb-2" th:text="${comment.text}"></p>
            <small class="text-muted text-light" th:text="${@prettyTime.format(comment.createdAt)}"></small>
        </div>
    </div>

    <footer th:insert="~{fragments/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
